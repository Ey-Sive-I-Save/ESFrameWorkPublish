# Playable动画状态机系统架构图

## 系统层次结构

```
┌─────────────────────────────────────────────────────────────────┐
│                   PlayableStateMachineController                 │
│                         (主控制器)                               │
│  - Initialize/Start/Stop                                        │
│  - 事件管理 (OnStateEntered/OnStateTransitioned)                │
│  - 参数设置 (SetFloat/SetInt/SetBool/SetTrigger)               │
└───────────────┬──────────────────┬──────────────────┬───────────┘
                │                  │                  │
                ▼                  ▼                  ▼
    ┌────────────────┐  ┌────────────────┐  ┌────────────────┐
    │  基本线Pipeline │  │  主线Pipeline  │  │  Buff线Pipeline│
    │  (Basic)       │  │  (Main)        │  │  (Buff)        │
    └────────┬───────┘  └────────┬───────┘  └────────┬───────┘
             │                   │                   │
             └─────────────┬─────┴───────────────────┘
                           ▼
                ┌─────────────────────┐
                │   Playable Graph    │
                │   (Unity Playable)  │
                │   混合并输出到       │
                │   Animator          │
                └─────────────────────┘
```

## 核心系统交互图

```
┌───────────────────────────────────────────────────────────────────┐
│                         核心系统层                                 │
├───────────────────────────────────────────────────────────────────┤
│                                                                   │
│  ┌─────────────────┐    ┌─────────────────┐    ┌──────────────┐│
│  │  StateContext   │◄───┤  CostManager    │◄───┤ Memoization  ││
│  │  (上下文参数)    │    │  (代价管理)      │    │  System      ││
│  │                 │    │                 │    │  (备忘状态)   ││
│  │  - Float        │    │  - 代价占用      │    │              ││
│  │  - Int          │    │  - 代价返还      │    │  - 性能优化  ││
│  │  - Bool         │    │  - 通道管理      │    │  - 冲突检测  ││
│  │  - Trigger      │    │  - 打断测试      │    │              ││
│  │  - Entity       │    └─────────────────┘    └──────────────┘│
│  │  - Curve        │                                            │
│  └─────────────────┘                                            │
│                                                                  │
└──────────────────────────────────────────────────────────────────┘
                               │
                               ▼
┌──────────────────────────────────────────────────────────────────┐
│                         数据层                                    │
├──────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌──────────────────┐         ┌──────────────────┐             │
│  │ StateMachineData │◄────────┤AnimationClipTable│             │
│  │ (ScriptableObject)│         │ (ScriptableObject)│             │
│  │                  │         │                  │             │
│  │  - Basic States  │         │  - Clip映射表     │             │
│  │  - Main States   │         │  - 支持复用       │             │
│  │  - Buff States   │         │  - 运行时修改     │             │
│  │  - 默认参数       │         └──────────────────┘             │
│  └──────────────────┘                                           │
│                                                                  │
└──────────────────────────────────────────────────────────────────┘
```

## 状态定义组件架构

```
┌─────────────────────────────────────────────────────────────────┐
│                      StateDefinition                             │
│                      (状态定义)                                   │
├─────────────────────────────────────────────────────────────────┤
│  基础属性:                                                        │
│  - stateId, stateName, pipelineType, priority, duration        │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐         │
│  │ 代价系统      │  │ 条件系统      │  │ 同路退化      │         │
│  │              │  │              │  │              │         │
│  │ StateCost    │  │ Conditions   │  │ SamePathType │         │
│  │ - 通道占用    │  │ - Enter      │  │ - 退化目标    │         │
│  │ - 后摇返还    │  │ - Exit       │  │ - 弱打断      │         │
│  └──────────────┘  │ - Keep       │  └──────────────┘         │
│                    └──────────────┘                            │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                  组件系统 (多态)                          │   │
│  ├─────────────────────────────────────────────────────────┤   │
│  │                                                         │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐    │   │
│  │  │Display      │  │Transition   │  │Execution    │    │   │
│  │  │Component    │  │Component    │  │Component    │    │   │
│  │  │             │  │             │  │             │    │   │
│  │  │- SingleClip │  │- Duration   │  │- OnEnter    │    │   │
│  │  │- MultiSeg   │  │- Curve      │  │- OnUpdate   │    │   │
│  │  │- Blending   │  │- Mode       │  │- OnExit     │    │   │
│  │  └─────────────┘  └─────────────┘  └─────────────┘    │   │
│  │                                                         │   │
│  │  ┌─────────────┐  ┌──────────────────────────┐        │   │
│  │  │IK Component │  │Custom Components         │        │   │
│  │  │             │  │(可扩展)                   │        │   │
│  │  │- Curve      │  │                          │        │   │
│  │  │- Bindings   │  │                          │        │   │
│  │  └─────────────┘  └──────────────────────────┘        │   │
│  │                                                         │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │               转换系统 (StateTransition)                 │   │
│  │  - 目标状态ID                                            │   │
│  │  - 转换条件                                              │   │
│  │  - 转换时间                                              │   │
│  │  - 强制标记                                              │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

## 代价系统工作流程

```
┌─────────────────────────────────────────────────────────────────┐
│                      状态进入流程                                 │
└─────────────────────────────────────────────────────────────────┘
                               │
                               ▼
                    ┌───────────────────┐
                    │  TryEnterState()  │
                    └─────────┬─────────┘
                              │
                              ▼
                    ┌───────────────────┐
                    │  检查备忘状态      │
                    │  IsStateDenied?   │
                    └─────────┬─────────┘
                              │
                 ┌────────────┴────────────┐
                 │                         │
                 ▼                         ▼
            ┌─────────┐              ┌─────────┐
            │  拒绝   │              │  通过   │
            └─────────┘              └────┬────┘
                                          │
                                          ▼
                              ┌───────────────────┐
                              │  检查进入条件      │
                              │  CheckConditions? │
                              └─────────┬─────────┘
                                        │
                           ┌────────────┴────────────┐
                           │                         │
                           ▼                         ▼
                      ┌─────────┐              ┌─────────┐
                      │  不满足 │              │  满足   │
                      └────┬────┘              └────┬────┘
                           │                        │
                           │                        ▼
                           │            ┌───────────────────┐
                           │            │  检查代价可用性    │
                           │            │  CanAffordCost?   │
                           │            └─────────┬─────────┘
                           │                      │
                           │         ┌────────────┴────────────┐
                           │         │                         │
                           │         ▼                         ▼
                           │    ┌─────────┐              ┌─────────┐
                           │    │  不足   │              │  充足   │
                           │    └────┬────┘              └────┬────┘
                           │         │                        │
                           │         ▼                        │
                           │  ┌──────────────┐               │
                           │  │  打断测试    │               │
                           │  │  - 优先级    │               │
                           │  │  - 同路退化  │               │
                           │  └──────┬───────┘               │
                           │         │                        │
                           │    ┌────┴────┐                  │
                           │    │         │                  │
                           ▼    ▼         ▼                  ▼
                      ┌─────────┐    ┌─────────────────────────┐
                      │ 记录拒绝 │    │     进入状态             │
                      │ (备忘)  │    │  1. 消耗代价             │
                      └─────────┘    │  2. 创建StateInstance    │
                                     │  3. 触发OnEnter          │
                                     │  4. 安排代价返还         │
                                     │  5. 标记备忘为脏         │
                                     └─────────────────────────┘
```

## 代价返还流程

```
┌─────────────────────────────────────────────────────────────────┐
│                      状态生命周期                                 │
└─────────────────────────────────────────────────────────────────┘

    0%                 70%                    100%
    │                  │                      │
    ▼                  ▼                      ▼
 ┌──────┐  ┌───────────────────┐  ┌──────────────┐
 │ 进入 │  │   执行阶段          │  │   退出       │
 │      │  │                   │  │              │
 │代价  │  │  normalizedTime   │  │  代价完全    │
 │消耗  │  │                   │  │  返还        │
 └──────┘  └───────────────────┘  └──────────────┘
                    │
                    ├─► recoveryStartTime (70%)
                    │   开始返还代价
                    │
                    └─► recoveryDuration (0.3s)
                        渐进返还至100%

返还计算:
  currentReturn = elapsed / duration
  returnAmount = EnterCostValue * currentReturn * ReturnFraction
  channelCost -= returnAmount
```

## 三条层级Mix输出

```
                   Playable Graph 架构
                   
    ┌────────────────────────────────────────────┐
    │         Root Mixer (AnimationMixer)        │
    │          权重归一化输出到Animator            │
    └──────┬──────────────┬──────────────┬───────┘
           │              │              │
      Weight=1.0     Weight=1.0     Weight=0.5
           │              │              │
           ▼              ▼              ▼
    ┌──────────┐   ┌──────────┐   ┌──────────┐
    │ 基本线    │   │ 主线     │   │ Buff线   │
    │ Mixer    │   │ Mixer    │   │ Mixer    │
    └────┬─────┘   └────┬─────┘   └────┬─────┘
         │              │              │
         ▼              ▼              ▼
    ┌─────────┐    ┌─────────┐    ┌─────────┐
    │Current  │    │Current  │    │Current  │
    │State    │    │State    │    │State    │
    │Playable │    │Playable │    │Playable │
    └─────────┘    └─────────┘    └─────────┘
         │              │              │
         ▼              ▼              ▼
    [跑/跳/蹲]      [技能/表情]      [Buff效果]
    基础动作        排斥动作         叠加效果
    
混合公式:
  FinalOutput = Basic * 1.0 + Main * 1.0 + Buff * 0.5
  (Unity Playable自动处理权重归一化)
```

## 类依赖关系图

```
PlayableStateMachineController
    ├─► StateMachineData (SO)
    │   ├─► StateDefinition[]
    │   │   ├─► StateCost
    │   │   ├─► StateCondition[]
    │   │   └─► StateComponent[]
    │   └─► AnimationClipTable (SO)
    │
    ├─► StateContext
    │   └─► Dictionary<string, T> (参数存储)
    │
    ├─► CostManager
    │   ├─► Dictionary<Channel, float>
    │   └─► List<CostReturnSchedule>
    │
    ├─► MemoizationSystem
    │   └─► Dictionary<StateId, DenialReason>
    │
    └─► StatePipeline[]
        ├─► StatePipeline (Basic)
        ├─► StatePipeline (Main)
        └─► StatePipeline (Buff)
            ├─► AnimationMixerPlayable
            └─► StateInstance (Current/Previous)
                ├─► StateDefinition
                └─► StateRuntime
                    └─► StateContext
```

## 性能优化点

1. **备忘状态系统**: 避免每帧重复测试条件,只在状态变化时刷新
2. **代价通道分离**: 独立管理各通道代价,细粒度控制
3. **组件化设计**: 按需加载组件,不使用的组件不执行
4. **Playable Graph**: 原生支持并行处理和混合
5. **字典缓存**: 快速查询参数和状态,O(1)复杂度

## 扩展点

1. **自定义StateComponent**: 继承StateComponent实现特殊逻辑
2. **自定义StateCondition**: 继承StateCondition实现复杂判断
3. **自定义StateAction**: 继承StateAction实现执行行为
4. **自定义ClipConfiguration**: 继承ClipConfiguration实现特殊Clip选择
5. **事件系统**: 监听OnStateEntered/OnStateTransitioned事件
